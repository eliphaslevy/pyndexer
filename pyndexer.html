<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>pyndexer.py</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="Generator" content="colorize.py (version 0.3)">
</head>
<body>
<style type="text/css">
pre.code {
    font-style: Lucida,"Courier New";
}

.number {
    color: #0080C0;
}
.operator {
    color: #000000;
}
.string {
    color: #008000;
}
.comment {
    color: #808080;
}
.name {
    color: #000000;
}
.error {
    color: #FF8080;
    border: solid 1.5pt #FF0000;
}
.keyword {
    color: #0000FF;
    font-weight: bold;
}
.text {
    color: #000000;
}

</style>

<pre class="code">
<span class="comment">#!/usr/bin/env python
</span><span class="comment"># coding: utf-8
</span><span class="comment"># vim:foldmethod=indent:ai:ts=4:sw=4
</span><span class="comment">#       pyndexer.py - Generates index.html recursively for a given directory
</span><span class="comment">#       Copyleft Eliphas Levy Theodoro
</span><span class="comment">#       http://www.opensource.org/licenses/simpl-2.0.html
</span><span class="comment">#       This script was primarily made for use with the Public Folder
</span><span class="comment">#       feature of Dropbox - http://www.dropbox.com
</span><span class="comment">#       See more information and get help at http://forums.dropbox.com/topic.php?id=3075
</span><span class="comment">#       Some ideas/code got from AJ's version at http://dl.dropbox.com/u/259928/www/indexerPY/index.html
</span>
<span class="name">version</span><span class="operator">=</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span><span class="number">1</span><span class="operator">,</span><span class="number">1</span><span class="operator">)</span>
<span class="name">base_source</span> <span class="operator">=</span> <span class="string">"http://dl.dropbox.com/u/552/pyndexer/%d.%d/"</span> <span class="operator">%</span> <span class="name">version</span><span class="operator">[</span><span class="operator">:</span><span class="number">2</span><span class="operator">]</span>

<span class="name">helptext</span><span class="operator">=</span><span class="string">'''pyndexer version %d.%d build %d

This script generates an index html file for dropbox public folders
Usage:
pyndexer [Folder1] [...] [FolderN]
  Starts index creation on [Folder1] and others.
  If no folder name given, will read configured sections on the INI file.
'''</span>

<span class="name">CHANGELOG</span><span class="operator">=</span><span class="string">"""
ChangeLog
2009-05-03.0.1
        First try
2009-05-03.0.2
        Ordering folders and files. Forgot it.
2009-05-06.0.3
        Ignoring the index file on the list
2009-09-10.0.4
        File sort order ignoring case
2009-12-07.0.5
        Added two decimal digits to HumanSize
        File sort order with locale (removed case insensitive kludge)
2010-01-16.0.6
        Added JW player support to MP3 files, if JW player files are found on the same folder
                Required files: (player.swf, swfobject.js)
        Added ?dl suffix on links to "generic" files (not html/htm/txt/php)
                Makes the browser download it instead of opening. Change viewInBrowser var to remove other files
        If an index.html file is found on the folder, check it against the new one for differences before overwriting
                Saves a sync action on dropbox and a recent events
        Added a non-recursive togglable option: (-R,--recursive) or (-N,--nonrecursive) - still defaults to recursive!
                Change recursiveDirs variable if want to change the default
        Added verbose (-v,--verbose) option to print indexed files and folders individually
        Added ignorePattern option: (-i,--ignore), accepting python's regex, ex: ['index\..*','\..*']
                You can ignore multiple patterns with multiple --ignore arguments
2010-02-04.0.7
        Added listing encryption (AES-256-CBC) support with javascript
                http://www.vincentcheung.ca/jsencryption/
2010-06-28.1.0 "mamooth version"
        Major split up of things, some rewrite
                External files for HTML, CSS, and javascript
                Global configuration file
                All command-line options dumped in favor of the config file
                You should designate a proper folder for this script from now on!
        Always non-recursive now, designate the folders to index in the config file
        Sync up with some changes from Andrew's 0.8 version (see forum thread for his changes)
        Will index all registered folders when called with no parameters
        Added the jwplayer to play the 'playinbrowser' files, like mp3 and mp4
        Changes after first release:
                2010-07-08 Added utf8 decode first thing, a little bug on decoding argv on linux
                2010-07-14 Fix for windows config, now will use forward slash even on win32
        TODO:
                wxwindow GUI on no parameters to ease preferences file edition
                javascript sorting, like andrew's version, but I want it to be locale-aware!
        Known issues:
                item count for folders can give away that there is a hidden folder
2011-01-04.1.0.1
        Move dropbox config database-related commands to a module (dbconfig.py)
                This is now a DEPENDENCY to the script (it will try to download itself).
                It fixes a potential bug regarding the changed default folder name on windows.
        Added reading a "readme" text/html file into the main index file.
2011-02-18.1.1.1
        This is what I should have done with 1.0.1, new minor version :)
        Just to add some icon extensions missing
        Now the exe version does not need to download dbconfig module, embedded
"""</span>


<span class="comment"># temporary file types dict for sprites - try to make it ordered by type, somewhat.
</span><span class="name">fileTypes</span> <span class="operator">=</span> <span class="operator">{</span>
<span class="comment"># web common</span>
        <span class="string">'pdf'</span><span class="operator">:</span> <span class="string">'s_page_white_acrobat'</span><span class="operator">,</span>
        <span class="string">'txt'</span><span class="operator">:</span> <span class="string">'s_page_white_text'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'css'</span><span class="operator">,</span> <span class="string">'js'</span><span class="operator">,</span> <span class="string">'htm'</span><span class="operator">,</span> <span class="string">'html'</span><span class="operator">,</span> <span class="string">'xml'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_code'</span><span class="operator">,</span>
<span class="comment"># images</span>
        <span class="operator">(</span><span class="string">'gif'</span><span class="operator">,</span> <span class="string">'jpg'</span><span class="operator">,</span> <span class="string">'jpeg'</span><span class="operator">,</span> <span class="string">'jpe'</span><span class="operator">,</span> <span class="string">'png'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_picture'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'ico'</span><span class="operator">,</span> <span class="string">'icns'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_picture'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'bmp'</span><span class="operator">,</span> <span class="string">'psd'</span><span class="operator">,</span> <span class="string">'tif'</span><span class="operator">,</span> <span class="string">'tiff'</span><span class="operator">,</span> <span class="string">'cr2'</span><span class="operator">,</span> <span class="string">'crw'</span><span class="operator">,</span> <span class="string">'nef'</span><span class="operator">)</span><span class="operator">:</span><span class="string">'s_page_white_picture'</span><span class="operator">,</span>
<span class="comment"># office</span>
        <span class="operator">(</span><span class="string">'doc'</span><span class="operator">,</span> <span class="string">'docx'</span><span class="operator">,</span> <span class="string">'odt'</span><span class="operator">,</span> <span class="string">'sxw'</span><span class="operator">,</span> <span class="string">'rtf'</span><span class="operator">,</span> <span class="string">'out'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_word'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'xls'</span><span class="operator">,</span> <span class="string">'xlsx'</span><span class="operator">,</span> <span class="string">'ods'</span><span class="operator">,</span> <span class="string">'sxc'</span><span class="operator">,</span> <span class="string">'csv'</span><span class="operator">,</span> <span class="string">'uos'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_excel'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'ppt'</span><span class="operator">,</span> <span class="string">'pptx'</span><span class="operator">,</span> <span class="string">'pps'</span><span class="operator">,</span> <span class="string">'ppsx'</span><span class="operator">,</span> <span class="string">'odp'</span><span class="operator">,</span> <span class="string">'sxi'</span><span class="operator">,</span> <span class="string">'uop'</span><span class="operator">,</span> <span class="string">'keynote'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_powerpoint'</span><span class="operator">,</span>
<span class="comment"># script/languages</span>
        <span class="string">'java'</span><span class="operator">:</span> <span class="string">'s_page_white_cup'</span><span class="operator">,</span>
        <span class="string">'php'</span><span class="operator">:</span> <span class="string">'s_page_white_php'</span><span class="operator">,</span>
        <span class="string">'rb'</span><span class="operator">:</span> <span class="string">'s_page_white_ruby'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'c'</span><span class="operator">,</span><span class="string">'h'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_c'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'bat'</span><span class="operator">,</span> <span class="string">'cmd'</span><span class="operator">,</span> <span class="string">'py'</span><span class="operator">,</span> <span class="string">'pl'</span><span class="operator">,</span> <span class="string">'sh'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_code'</span><span class="operator">,</span>
<span class="comment"># compressed</span>
        <span class="operator">(</span><span class="string">'7z'</span><span class="operator">,</span> <span class="string">'ace'</span><span class="operator">,</span> <span class="string">'arj'</span><span class="operator">,</span> <span class="string">'bz2'</span><span class="operator">,</span> <span class="string">'gz'</span><span class="operator">,</span> <span class="string">'rar'</span><span class="operator">,</span> <span class="string">'tar'</span><span class="operator">,</span> <span class="string">'tbz'</span><span class="operator">,</span> <span class="string">'tgz'</span><span class="operator">,</span> <span class="string">'zip'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_compressed'</span><span class="operator">,</span>
<span class="comment"># audio/video</span>
        <span class="operator">(</span><span class="string">'aiff'</span><span class="operator">,</span> <span class="string">'aac'</span><span class="operator">,</span> <span class="string">'flac'</span><span class="operator">,</span> <span class="string">'kar'</span><span class="operator">,</span> <span class="string">'m4a'</span><span class="operator">,</span> <span class="string">'mid'</span><span class="operator">,</span> <span class="string">'midi'</span><span class="operator">,</span> <span class="string">'mp3'</span><span class="operator">,</span> <span class="string">'oga'</span><span class="operator">,</span> <span class="string">'ogg'</span><span class="operator">,</span> <span class="string">'shn'</span><span class="operator">,</span> <span class="string">'wav'</span><span class="operator">,</span> <span class="string">'wma'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_sound'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'avi'</span><span class="operator">,</span> <span class="string">'m4v'</span><span class="operator">,</span> <span class="string">'mp4'</span><span class="operator">,</span> <span class="string">'mpeg'</span><span class="operator">,</span> <span class="string">'mpg'</span><span class="operator">,</span> <span class="string">'ogv'</span><span class="operator">,</span> <span class="string">'mkv'</span><span class="operator">,</span> <span class="string">'mov'</span><span class="operator">,</span> <span class="string">'wmv'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_film'</span><span class="operator">,</span>
<span class="comment"># others</span>
        <span class="operator">(</span><span class="string">'dmg'</span><span class="operator">,</span> <span class="string">'iso'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_dvd'</span><span class="operator">,</span>
        <span class="operator">(</span><span class="string">'dll'</span><span class="operator">,</span> <span class="string">'exe'</span><span class="operator">,</span> <span class="string">'com'</span><span class="operator">)</span><span class="operator">:</span> <span class="string">'s_page_white_gear'</span><span class="operator">,</span>
        <span class="name">None</span><span class="operator">:</span> <span class="string">'s_page_white'</span><span class="operator">,</span>
        <span class="operator">}</span>
<span class="comment"># on first run let's make the dict right
</span><span class="keyword">for</span> <span class="name">exts</span><span class="operator">,</span> <span class="name">desc</span> <span class="keyword">in</span> <span class="name">fileTypes</span><span class="operator">.</span><span class="name">items</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">type</span><span class="operator">(</span><span class="name">exts</span><span class="operator">)</span> <span class="operator">==</span> <span class="name">type</span><span class="operator">(</span><span class="name">tuple</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span><span class="operator">:</span> <span class="keyword">continue</span>
        <span class="keyword">for</span> <span class="name">ext</span> <span class="keyword">in</span> <span class="name">exts</span><span class="operator">:</span> <span class="name">fileTypes</span><span class="operator">[</span><span class="name">ext</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">desc</span>
        <span class="keyword">del</span><span class="operator">(</span><span class="name">fileTypes</span><span class="operator">[</span><span class="name">exts</span><span class="operator">]</span><span class="operator">)</span>
<span class="keyword">del</span> <span class="name">desc</span><span class="operator">,</span> <span class="name">exts</span>

<span class="keyword">import</span> <span class="name">os</span><span class="operator">,</span> <span class="name">sys</span><span class="operator">,</span> <span class="name">codecs</span><span class="operator">,</span> <span class="name">ConfigParser</span>
<span class="keyword">from</span> <span class="name">hashlib</span> <span class="keyword">import</span> <span class="name">md5</span>
<span class="keyword">from</span> <span class="name">xml</span><span class="operator">.</span><span class="name">dom</span> <span class="keyword">import</span> <span class="name">minidom</span>
<span class="keyword">from</span> <span class="name">datetime</span> <span class="keyword">import</span> <span class="name">datetime</span> <span class="keyword">as</span> <span class="name">dt</span>
<span class="keyword">from</span> <span class="name">locale</span> <span class="keyword">import</span> <span class="name">setlocale</span><span class="operator">,</span> <span class="name">strcoll</span><span class="operator">,</span> <span class="name">LC_ALL</span>
<span class="keyword">from</span> <span class="name">urllib</span> <span class="keyword">import</span> <span class="name">urlopen</span>
<span class="keyword">from</span> <span class="name">fnmatch</span> <span class="keyword">import</span> <span class="name">fnmatch</span>

<span class="keyword">try</span><span class="operator">:</span>
        <span class="keyword">import</span> <span class="name">dbconfig</span>
<span class="keyword">except</span> <span class="name">ImportError</span><span class="operator">:</span>
        <span class="name">mod_name</span> <span class="operator">=</span> <span class="string">'dbconfig.py'</span>
        <span class="name">mod_source</span> <span class="operator">=</span> <span class="string">"http://dl.dropbox.com/u/552/dbconfig/"</span>
        <span class="keyword">print</span> <span class="string">'I will try to download dbconfig.py for you, ok?\n(will save on this script folder)'</span>
        <span class="name">r</span> <span class="operator">=</span> <span class="name">raw_input</span><span class="operator">(</span><span class="string">'[Y/n] and ENTER:'</span><span class="operator">)</span><span class="operator">.</span><span class="name">lower</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span>
        <span class="keyword">if</span> <span class="name">r</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="operator">(</span><span class="string">'y'</span><span class="operator">,</span><span class="string">''</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">print</span> <span class="string">'Exiting.'</span>
                <span class="name">sys</span><span class="operator">.</span><span class="name">exit</span><span class="operator">(</span><span class="number">1</span><span class="operator">)</span>
        <span class="name">dbc</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">dirname</span><span class="operator">(</span><span class="name">sys</span><span class="operator">.</span><span class="name">argv</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">)</span><span class="operator">,</span> <span class="name">mod_name</span><span class="operator">)</span>
        <span class="keyword">try</span><span class="operator">:</span>
                <span class="name">file</span><span class="operator">(</span><span class="name">dbc</span><span class="operator">,</span><span class="string">'wb'</span><span class="operator">)</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">urlopen</span><span class="operator">(</span><span class="name">mod_source</span><span class="operator">+</span><span class="name">mod_name</span><span class="operator">)</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span>
                <span class="keyword">import</span> <span class="name">dbconfig</span>
        <span class="keyword">except</span><span class="operator">:</span>
                <span class="keyword">print</span><span class="operator">(</span><span class="string">'ERROR: %s module not found. Download to same place as this script.'</span> <span class="operator">%</span> <span class="name">mod_name</span><span class="operator">)</span>
                <span class="keyword">print</span><span class="operator">(</span><span class="string">'URL: '</span><span class="operator">+</span><span class="name">mod_source</span><span class="operator">+</span><span class="string">'index.html'</span><span class="operator">)</span>
                <span class="keyword">raise</span>

<span class="name">hascrypto</span><span class="operator">=</span><span class="name">False</span>
<span class="keyword">try</span><span class="operator">:</span>
        <span class="keyword">from</span> <span class="name">M2Crypto</span> <span class="keyword">import</span> <span class="name">EVP</span>
        <span class="keyword">from</span> <span class="name">cStringIO</span> <span class="keyword">import</span> <span class="name">StringIO</span>
        <span class="keyword">from</span> <span class="name">textwrap</span> <span class="keyword">import</span> <span class="name">wrap</span>
        <span class="name">hascrypto</span> <span class="operator">=</span> <span class="name">True</span>
<span class="keyword">except</span> <span class="name">ImportError</span><span class="operator">:</span>
        <span class="keyword">print</span><span class="operator">(</span><span class="string">'INFO: no M2Crypto support detected'</span><span class="operator">)</span>


<span class="comment"># On windows command line, python &lt;=2.5 will not handle unicode correctly. This works around this.
</span><span class="keyword">def</span> <span class="name">GetArgv</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''code adapted from http://code.activestate.com/recipes/572200/'''</span>
        <span class="keyword">if</span> <span class="name">sys</span><span class="operator">.</span><span class="name">platform</span> <span class="operator">!=</span> <span class="string">'win32'</span><span class="operator">:</span>
                <span class="keyword">return</span> <span class="name">sys</span><span class="operator">.</span><span class="name">argv</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="keyword">from</span> <span class="name">ctypes</span> <span class="keyword">import</span> <span class="name">POINTER</span><span class="operator">,</span> <span class="name">byref</span><span class="operator">,</span> <span class="name">cdll</span><span class="operator">,</span> <span class="name">c_int</span><span class="operator">,</span> <span class="name">windll</span>
                <span class="keyword">from</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">wintypes</span> <span class="keyword">import</span> <span class="name">LPCWSTR</span><span class="operator">,</span> <span class="name">LPWSTR</span>
                <span class="name">GetCommandLineW</span> <span class="operator">=</span> <span class="name">cdll</span><span class="operator">.</span><span class="name">kernel32</span><span class="operator">.</span><span class="name">GetCommandLineW</span>
                <span class="name">GetCommandLineW</span><span class="operator">.</span><span class="name">argtypes</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span>
                <span class="name">GetCommandLineW</span><span class="operator">.</span><span class="name">restype</span> <span class="operator">=</span> <span class="name">LPCWSTR</span>
                <span class="name">CommandLineToArgvW</span> <span class="operator">=</span> <span class="name">windll</span><span class="operator">.</span><span class="name">shell32</span><span class="operator">.</span><span class="name">CommandLineToArgvW</span>
                <span class="name">CommandLineToArgvW</span><span class="operator">.</span><span class="name">argtypes</span> <span class="operator">=</span> <span class="operator">[</span><span class="name">LPCWSTR</span><span class="operator">,</span> <span class="name">POINTER</span><span class="operator">(</span><span class="name">c_int</span><span class="operator">)</span><span class="operator">]</span>
                <span class="name">CommandLineToArgvW</span><span class="operator">.</span><span class="name">restype</span> <span class="operator">=</span> <span class="name">POINTER</span><span class="operator">(</span><span class="name">LPWSTR</span><span class="operator">)</span>
                <span class="name">cmd</span> <span class="operator">=</span> <span class="name">GetCommandLineW</span><span class="operator">(</span><span class="operator">)</span>
                <span class="name">argc</span> <span class="operator">=</span> <span class="name">c_int</span><span class="operator">(</span><span class="number">0</span><span class="operator">)</span>
                <span class="name">argv</span> <span class="operator">=</span> <span class="name">CommandLineToArgvW</span><span class="operator">(</span><span class="name">cmd</span><span class="operator">,</span> <span class="name">byref</span><span class="operator">(</span><span class="name">argc</span><span class="operator">)</span><span class="operator">)</span>
                <span class="keyword">if</span> <span class="name">argc</span><span class="operator">.</span><span class="name">value</span> <span class="operator">&gt;</span> <span class="number">0</span><span class="operator">:</span>
                                <span class="keyword">if</span> <span class="name">argc</span><span class="operator">.</span><span class="name">value</span> <span class="operator">-</span> <span class="name">len</span><span class="operator">(</span><span class="name">sys</span><span class="operator">.</span><span class="name">argv</span><span class="operator">)</span> <span class="operator">==</span> <span class="number">1</span><span class="operator">:</span>
                                                <span class="name">start</span> <span class="operator">=</span> <span class="number">1</span>
                                <span class="keyword">else</span><span class="operator">:</span>
                                                <span class="name">start</span> <span class="operator">=</span> <span class="number">0</span>
                                <span class="keyword">return</span> <span class="operator">[</span><span class="name">argv</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span> <span class="keyword">for</span> <span class="name">i</span> <span class="keyword">in</span> <span class="name">xrange</span><span class="operator">(</span><span class="name">start</span><span class="operator">,</span> <span class="name">argc</span><span class="operator">.</span><span class="name">value</span><span class="operator">)</span><span class="operator">]</span>
                <span class="keyword">else</span><span class="operator">:</span>
                                <span class="keyword">return</span> <span class="operator">[</span><span class="operator">]</span>


<span class="keyword">def</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">html</span><span class="operator">,</span><span class="name">tag</span><span class="operator">,</span><span class="name">tid</span><span class="operator">=</span><span class="name">None</span><span class="operator">,</span><span class="name">cls</span><span class="operator">=</span><span class="name">None</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''Gets an element by ID or class'''</span>
        <span class="keyword">for</span> <span class="name">e</span> <span class="keyword">in</span> <span class="name">html</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="name">tag</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">tid</span><span class="operator">:</span>
                        <span class="keyword">if</span> <span class="name">e</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'id'</span><span class="operator">)</span><span class="operator">==</span><span class="name">tid</span><span class="operator">:</span> <span class="keyword">return</span> <span class="name">e</span>
                <span class="keyword">elif</span> <span class="name">cls</span><span class="operator">:</span>
                        <span class="keyword">if</span> <span class="name">e</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">)</span><span class="operator">==</span><span class="name">cls</span><span class="operator">:</span> <span class="keyword">return</span> <span class="name">e</span>
                <span class="keyword">else</span><span class="operator">:</span>
                        <span class="keyword">return</span> <span class="name">e</span>
        <span class="keyword">return</span> <span class="name">None</span>


<span class="keyword">def</span> <span class="name">delElem</span><span class="operator">(</span><span class="name">e</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''removes a dom child from the parent'''</span>
        <span class="name">e</span><span class="operator">.</span><span class="name">parentNode</span><span class="operator">.</span><span class="name">removeChild</span><span class="operator">(</span><span class="name">e</span><span class="operator">)</span>
        <span class="name">e</span><span class="operator">.</span><span class="name">parentNode</span><span class="operator">=</span><span class="name">None</span>


<span class="keyword">def</span> <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">node</span><span class="operator">,</span><span class="name">dic</span><span class="operator">)</span><span class="operator">:</span>
        <span class="keyword">for</span> <span class="name">e</span> <span class="keyword">in</span> <span class="name">node</span><span class="operator">.</span><span class="name">childNodes</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">e</span><span class="operator">.</span><span class="name">nodeType</span> <span class="operator">==</span> <span class="name">e</span><span class="operator">.</span><span class="name">TEXT_NODE</span><span class="operator">:</span>
                        <span class="name">e</span><span class="operator">.</span><span class="name">replaceWholeText</span><span class="operator">(</span><span class="name">e</span><span class="operator">.</span><span class="name">wholeText</span> <span class="operator">%</span> <span class="name">dic</span><span class="operator">)</span>


<span class="keyword">def</span> <span class="name">setEntryRow</span><span class="operator">(</span><span class="name">tdata</span><span class="operator">,</span><span class="name">dic</span><span class="operator">)</span><span class="operator">:</span>
        <span class="keyword">for</span> <span class="name">td</span> <span class="keyword">in</span> <span class="name">tdata</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">td</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">u'row1'</span><span class="operator">:</span>
                        <span class="name">a</span> <span class="operator">=</span> <span class="name">td</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'a'</span><span class="operator">)</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span>
                        <span class="name">a</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">,</span> <span class="name">a</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">)</span> <span class="operator">%</span> <span class="name">dic</span><span class="operator">)</span>
                        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">a</span><span class="operator">,</span> <span class="name">dic</span><span class="operator">)</span>
                        <span class="name">img</span> <span class="operator">=</span> <span class="name">td</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'img'</span><span class="operator">)</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span>
                        <span class="name">img</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">,</span> <span class="name">img</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">)</span> <span class="operator">%</span> <span class="name">dic</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">td</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">u'row2'</span><span class="operator">:</span>
                        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">td</span><span class="operator">,</span> <span class="name">dic</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">td</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'class'</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">u'row3'</span><span class="operator">:</span>
                        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">td</span><span class="operator">,</span> <span class="name">dic</span><span class="operator">)</span>


<span class="keyword">def</span> <span class="name">patmatch</span><span class="operator">(</span><span class="name">somename</span><span class="operator">,</span> <span class="name">patlist</span><span class="operator">)</span><span class="operator">:</span> <span class="comment"># magic!</span>
        <span class="keyword">return</span> <span class="name">sum</span><span class="operator">(</span><span class="operator">[</span><span class="name">fnmatch</span><span class="operator">(</span><span class="name">somename</span><span class="operator">,</span> <span class="name">pat</span><span class="operator">)</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> <span class="number">0</span> <span class="keyword">for</span> <span class="name">pat</span> <span class="keyword">in</span> <span class="name">patlist</span><span class="operator">]</span><span class="operator">)</span>


<span class="keyword">def</span> <span class="name">HumanSize</span><span class="operator">(</span><span class="name">bytes</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''Humanize a given byte size'''</span>
        <span class="keyword">if</span> <span class="name">bytes</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span><span class="operator">:</span>
                <span class="keyword">return</span> <span class="string">"%.2f GB"</span> <span class="operator">%</span> <span class="name">round</span><span class="operator">(</span><span class="name">bytes</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024.0</span><span class="operator">,</span><span class="number">2</span><span class="operator">)</span>
        <span class="keyword">elif</span> <span class="name">bytes</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span><span class="operator">:</span>
                <span class="keyword">return</span> <span class="string">"%.2f MB"</span> <span class="operator">%</span> <span class="name">round</span><span class="operator">(</span><span class="name">bytes</span><span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024.0</span><span class="operator">,</span><span class="number">2</span><span class="operator">)</span>
        <span class="keyword">elif</span> <span class="name">bytes</span><span class="operator">/</span><span class="number">1024</span><span class="operator">:</span>
                <span class="keyword">return</span> <span class="string">"%d KB"</span> <span class="operator">%</span> <span class="name">round</span><span class="operator">(</span><span class="name">bytes</span><span class="operator">/</span><span class="number">1024.0</span><span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="keyword">return</span> <span class="string">"%d bytes"</span> <span class="operator">%</span> <span class="name">bytes</span>


<span class="keyword">def</span> <span class="name">encrypt</span><span class="operator">(</span><span class="name">string</span><span class="operator">,</span> <span class="name">password</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''Encrypt with AES some string'''</span>
        <span class="name">prefix</span> <span class="operator">=</span> <span class="string">'Salted__'</span>
        <span class="name">salt</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">urandom</span><span class="operator">(</span><span class="number">8</span><span class="operator">)</span>
        <span class="name">hash</span> <span class="operator">=</span> <span class="operator">[</span><span class="string">''</span><span class="operator">]</span>
        <span class="keyword">for</span> <span class="name">i</span> <span class="keyword">in</span> <span class="name">range</span><span class="operator">(</span><span class="number">4</span><span class="operator">)</span><span class="operator">:</span>
                <span class="name">hash</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">md5</span><span class="operator">(</span><span class="name">hash</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span> <span class="operator">+</span> <span class="name">password</span><span class="operator">.</span><span class="name">encode</span><span class="operator">(</span><span class="string">'ascii'</span><span class="operator">)</span> <span class="operator">+</span> <span class="name">salt</span><span class="operator">)</span><span class="operator">.</span><span class="name">digest</span><span class="operator">(</span><span class="operator">)</span> <span class="operator">)</span>
        <span class="name">key</span><span class="operator">,</span> <span class="name">iv</span> <span class="operator">=</span>  <span class="name">hash</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span> <span class="operator">+</span> <span class="name">hash</span><span class="operator">[</span><span class="number">2</span><span class="operator">]</span><span class="operator">,</span> <span class="name">hash</span><span class="operator">[</span><span class="number">3</span><span class="operator">]</span> <span class="operator">+</span> <span class="name">hash</span><span class="operator">[</span><span class="number">4</span><span class="operator">]</span>
        <span class="keyword">del</span> <span class="name">hash</span>
        <span class="name">cipher</span> <span class="operator">=</span> <span class="name">EVP</span><span class="operator">.</span><span class="name">Cipher</span><span class="operator">(</span><span class="name">alg</span><span class="operator">=</span><span class="string">'aes_256_cbc'</span><span class="operator">,</span> <span class="name">key</span><span class="operator">=</span><span class="name">key</span><span class="operator">,</span> <span class="name">iv</span><span class="operator">=</span><span class="name">iv</span><span class="operator">,</span> <span class="name">op</span><span class="operator">=</span><span class="number">1</span><span class="operator">)</span>
        <span class="name">inpb</span><span class="operator">,</span> <span class="name">outb</span> <span class="operator">=</span> <span class="name">StringIO</span><span class="operator">(</span><span class="name">string</span><span class="operator">)</span><span class="operator">,</span> <span class="name">StringIO</span><span class="operator">(</span><span class="operator">)</span>
        <span class="keyword">while</span> <span class="number">1</span><span class="operator">:</span>
                <span class="name">buf</span> <span class="operator">=</span> <span class="name">inpb</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span>
                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">buf</span><span class="operator">:</span> <span class="keyword">break</span>
                <span class="name">outb</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">cipher</span><span class="operator">.</span><span class="name">update</span><span class="operator">(</span><span class="name">buf</span><span class="operator">)</span><span class="operator">)</span>
                <span class="name">outb</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">cipher</span><span class="operator">.</span><span class="name">final</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span>
        <span class="name">ciphertext</span> <span class="operator">=</span> <span class="name">outb</span><span class="operator">.</span><span class="name">getvalue</span><span class="operator">(</span><span class="operator">)</span>
        <span class="name">inpb</span><span class="operator">.</span><span class="name">close</span><span class="operator">(</span><span class="operator">)</span>
        <span class="name">outb</span><span class="operator">.</span><span class="name">close</span><span class="operator">(</span><span class="operator">)</span>
        <span class="keyword">return</span> <span class="operator">(</span><span class="name">prefix</span><span class="operator">+</span><span class="name">salt</span><span class="operator">+</span><span class="name">ciphertext</span><span class="operator">)</span><span class="operator">.</span><span class="name">encode</span><span class="operator">(</span><span class="string">'base64'</span><span class="operator">)</span>


<span class="keyword">def</span> <span class="name">lsdir</span><span class="operator">(</span><span class="name">config</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''reads config, then list directories and files'''</span>
        <span class="comment"># FIXME this should be tweaked, it's re-reading a default config everytime.
</span>        <span class="comment"># at least these ones should not be needing to change based on folder
</span>        <span class="name">confdict</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span>
        <span class="name">allvars</span> <span class="operator">=</span> <span class="operator">(</span>
                <span class="comment"># global vars</span>
                <span class="string">'my_source'</span><span class="operator">,</span><span class="string">'pyndexer_url'</span><span class="operator">,</span> <span class="string">'dropbox_referrer'</span><span class="operator">,</span><span class="string">'indexfilename'</span><span class="operator">,</span><span class="string">'dateformat'</span><span class="operator">,</span>
                <span class="comment"># local vars</span>
                <span class="string">'sortby'</span><span class="operator">,</span><span class="string">'subdirsize'</span><span class="operator">,</span><span class="string">'ignorepattern'</span><span class="operator">,</span><span class="string">'viewinbrowser'</span><span class="operator">,</span><span class="string">'playinbrowser'</span><span class="operator">,</span><span class="string">'skipdir'</span><span class="operator">,</span><span class="string">'password'</span><span class="operator">,</span><span class="string">'readme'</span><span class="operator">,</span>
                <span class="operator">)</span>
        <span class="name">section</span> <span class="operator">=</span> <span class="string">'DEFAULT'</span>
        <span class="name">splitdirname</span> <span class="operator">=</span> <span class="name">dirname</span><span class="operator">.</span><span class="name">replace</span><span class="operator">(</span><span class="name">config</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">section</span><span class="operator">,</span><span class="string">'publicfolder'</span><span class="operator">)</span><span class="operator">,</span><span class="string">''</span><span class="operator">)</span>
        <span class="comment"># fix for windows
</span>        <span class="keyword">if</span> <span class="name">sys</span><span class="operator">.</span><span class="name">platform</span> <span class="operator">==</span> <span class="string">'win32'</span><span class="operator">:</span>
                <span class="name">splitdirname</span> <span class="operator">=</span> <span class="name">splitdirname</span><span class="operator">.</span><span class="name">replace</span><span class="operator">(</span><span class="string">'\\'</span><span class="operator">,</span><span class="string">'/'</span><span class="operator">)</span>
        <span class="keyword">if</span> <span class="name">splitdirname</span> <span class="keyword">in</span> <span class="name">config</span><span class="operator">.</span><span class="name">sections</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span>
                <span class="name">section</span> <span class="operator">=</span> <span class="name">splitdirname</span>
        <span class="keyword">for</span> <span class="name">k</span> <span class="keyword">in</span> <span class="name">allvars</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">k</span> <span class="operator">==</span> <span class="string">'dateformat'</span><span class="operator">:</span> <span class="comment"># date format needs to be raw because of the percents</span>
                        <span class="name">confdict</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">config</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">section</span><span class="operator">,</span> <span class="name">k</span><span class="operator">,</span> <span class="number">1</span><span class="operator">)</span><span class="operator">.</span><span class="name">encode</span><span class="operator">(</span><span class="string">'ascii'</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">k</span> <span class="keyword">in</span> <span class="operator">(</span><span class="string">'ignorepattern'</span><span class="operator">,</span><span class="string">'viewinbrowser'</span><span class="operator">,</span><span class="string">'playinbrowser'</span><span class="operator">)</span><span class="operator">:</span> <span class="comment"># this is list</span>
                        <span class="name">confdict</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span> <span class="operator">=</span> <span class="operator">[</span><span class="name">i</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span> <span class="keyword">for</span> <span class="name">i</span> <span class="keyword">in</span> <span class="name">config</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">section</span><span class="operator">,</span> <span class="name">k</span><span class="operator">)</span><span class="operator">.</span><span class="name">split</span><span class="operator">(</span><span class="string">','</span><span class="operator">)</span><span class="operator">]</span>
                <span class="keyword">else</span><span class="operator">:</span>
                        <span class="name">confdict</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">config</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">section</span><span class="operator">,</span> <span class="name">k</span><span class="operator">)</span>

        <span class="name">dirs</span><span class="operator">,</span> <span class="name">files</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span><span class="operator">,</span> <span class="operator">{</span><span class="operator">}</span>
        <span class="keyword">for</span> <span class="name">name</span> <span class="keyword">in</span> <span class="name">os</span><span class="operator">.</span><span class="name">listdir</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">patmatch</span><span class="operator">(</span><span class="name">name</span><span class="operator">,</span> <span class="name">confdict</span><span class="operator">[</span><span class="string">'ignorepattern'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="keyword">continue</span> <span class="comment"># ignored folder/file</span>
                <span class="name">n</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">,</span> <span class="name">name</span><span class="operator">)</span>
                <span class="keyword">if</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isdir</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="comment"># disabled because of recursivity... need sub folder counts :( FIXME
</span>                        <span class="comment">#if confdict[n]['skipdir'] == 'yes': continue # explicitly ignored folder
</span>                        <span class="name">dirs</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">islink</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span> <span class="keyword">and</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isdir</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">realpath</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="comment"># XXX will choke in infinite loops, be aware. (untested!)
</span>                        <span class="name">dirs</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">abspath</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">realpath</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">)</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isfile</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="name">files</span><span class="operator">[</span><span class="name">n</span><span class="operator">]</span><span class="operator">=</span><span class="name">dict</span><span class="operator">(</span>
                                <span class="name">size</span><span class="operator">=</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">getsize</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">,</span>
                                <span class="name">ctime</span><span class="operator">=</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">getmtime</span><span class="operator">(</span><span class="name">n</span><span class="operator">)</span><span class="operator">,</span>
                                <span class="operator">)</span>
                <span class="keyword">else</span><span class="operator">:</span>
                        <span class="keyword">raise</span> <span class="name">Exception</span><span class="operator">(</span><span class="string">'Ouch, do not know what to do with "%s". Abort.'</span> <span class="operator">%</span> <span class="name">name</span><span class="operator">)</span>
        <span class="name">ctime</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">getmtime</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span>
        <span class="name">size</span> <span class="operator">=</span> <span class="name">sum</span><span class="operator">(</span><span class="operator">[</span><span class="name">files</span><span class="operator">[</span><span class="name">f</span><span class="operator">]</span><span class="operator">[</span><span class="string">'size'</span><span class="operator">]</span> <span class="keyword">for</span> <span class="name">f</span> <span class="keyword">in</span> <span class="name">files</span><span class="operator">]</span><span class="operator">)</span>

        <span class="keyword">return</span> <span class="name">dict</span><span class="operator">(</span><span class="name">confdict</span><span class="operator">=</span><span class="name">confdict</span><span class="operator">,</span> <span class="name">ctime</span><span class="operator">=</span><span class="name">ctime</span><span class="operator">,</span> <span class="name">size</span><span class="operator">=</span><span class="name">size</span><span class="operator">,</span> <span class="name">count</span><span class="operator">=</span><span class="name">len</span><span class="operator">(</span><span class="name">dirs</span><span class="operator">)</span><span class="operator">+</span><span class="name">len</span><span class="operator">(</span><span class="name">files</span><span class="operator">)</span><span class="operator">,</span> <span class="name">dirs</span><span class="operator">=</span><span class="name">dirs</span><span class="operator">,</span> <span class="name">files</span><span class="operator">=</span><span class="name">files</span><span class="operator">)</span>


<span class="keyword">def</span> <span class="name">walkdir</span><span class="operator">(</span><span class="name">config</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">parent</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''recursive list'''</span>
        <span class="keyword">if</span> <span class="name">indexingdict</span><span class="operator">.</span><span class="name">has_key</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span> <span class="keyword">return</span>
        <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">lsdir</span><span class="operator">(</span><span class="name">config</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span>
        <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'parent'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">parent</span>
        <span class="keyword">for</span> <span class="name">subdir</span> <span class="keyword">in</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'dirs'</span><span class="operator">]</span><span class="operator">:</span>
                <span class="name">walkdir</span><span class="operator">(</span><span class="name">config</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">,</span> <span class="name">subdir</span><span class="operator">)</span>
                <span class="comment">#XXX should I recursively add sizes and counts? (untested)
</span>                <span class="comment">#indexingdict[dirname]['size'] += indexingdict[subdir]['size']
</span>                <span class="comment">#indexingdict[dirname]['count'] += indexingdict[subdir]['count']
</span>

<span class="keyword">def</span> <span class="name">getNodesDict</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">)</span><span class="operator">:</span>
        <span class="name">dic</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'jsenc'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'script'</span><span class="operator">,</span> <span class="string">'jsenc'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'encryptedrow'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="string">'encryptedrow'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'jsswfobj'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'script'</span><span class="operator">,</span> <span class="string">'jsswfobj'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'jsjwplay'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'script'</span><span class="operator">,</span> <span class="string">'jsjwplay'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'jwplayerrow'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="string">'jwplayerrow'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'playerdiv'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'span'</span><span class="operator">,</span><span class="string">'playerdiv'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'md5span'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'span'</span><span class="operator">,</span><span class="string">'md5span'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'title'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'title'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'dropboxref'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'a'</span><span class="operator">,</span><span class="string">'dropboxref'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'currentfolderth'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'th'</span><span class="operator">,</span><span class="string">'currentfolderth'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'lastmodifiedth'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'th'</span><span class="operator">,</span><span class="string">'lastmodifiedth'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'pyndexerref'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'a'</span><span class="operator">,</span><span class="string">'pyndexerref'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'updirtr'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="string">'updirtr'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'updirref'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'a'</span><span class="operator">,</span><span class="string">'updirref'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tbody'</span><span class="operator">,</span><span class="string">'maintablebody'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'emptytr'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="string">'emptytr'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'direntry'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="name">None</span><span class="operator">,</span><span class="string">'direntry'</span><span class="operator">)</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'fileentry'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span><span class="name">None</span><span class="operator">,</span><span class="string">'fileentry'</span><span class="operator">)</span>

        <span class="name">dic</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'div'</span><span class="operator">,</span> <span class="string">'readme'</span><span class="operator">)</span>
        <span class="keyword">for</span> <span class="name">k</span> <span class="keyword">in</span> <span class="name">dic</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">dic</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span><span class="operator">:</span>
                        <span class="keyword">raise</span> <span class="name">Exception</span><span class="operator">(</span><span class="string">'Ooops, html template not ok. (%s parse failed)'</span> <span class="operator">%</span> <span class="name">k</span><span class="operator">)</span>
        <span class="keyword">return</span> <span class="name">dic</span>


<span class="keyword">def</span> <span class="name">index</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''write the index file.'''</span>
        <span class="string">'''globals needed: config'''</span>
        <span class="name">c</span> <span class="operator">=</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'confdict'</span><span class="operator">]</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">c</span><span class="operator">[</span><span class="string">'skipdir'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'no'</span><span class="operator">:</span> <span class="comment"># will not index this folder!</span>
                <span class="keyword">return</span> <span class="name">False</span>
        <span class="name">htmlbase</span> <span class="operator">=</span> <span class="name">minidom</span><span class="operator">.</span><span class="name">parse</span><span class="operator">(</span><span class="name">template</span><span class="operator">)</span>
        <span class="name">dic</span> <span class="operator">=</span> <span class="name">getNodesDict</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">)</span>
        <span class="comment"># remove base html objects for folders and files
</span>        <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'emptytr'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'direntry'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'fileentry'</span><span class="operator">]</span><span class="operator">)</span>

        <span class="name">dirs</span> <span class="operator">=</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'dirs'</span><span class="operator">]</span>
        <span class="name">files</span> <span class="operator">=</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'files'</span><span class="operator">]</span>

        <span class="keyword">if</span> <span class="name">c</span><span class="operator">[</span><span class="string">'sortby'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'name'</span><span class="operator">:</span>
                <span class="name">dirnames</span>  <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">dirs</span><span class="operator">,</span> <span class="name">cmp</span><span class="operator">=</span><span class="name">strcoll</span><span class="operator">)</span>
                <span class="name">filenames</span> <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">files</span><span class="operator">,</span> <span class="name">cmp</span><span class="operator">=</span><span class="name">strcoll</span><span class="operator">)</span>
        <span class="keyword">elif</span> <span class="name">c</span><span class="operator">[</span><span class="string">'sortby'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'size'</span><span class="operator">:</span>
                <span class="name">dirnames</span>  <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">dirs</span><span class="operator">,</span>  <span class="name">key</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">k</span><span class="operator">:</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span><span class="operator">[</span><span class="string">'size'</span><span class="operator">]</span> <span class="operator">)</span>
                <span class="name">filenames</span> <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">files</span><span class="operator">,</span> <span class="name">key</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">k</span><span class="operator">:</span> <span class="name">files</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span><span class="operator">[</span><span class="string">'size'</span><span class="operator">]</span> <span class="operator">)</span>
        <span class="keyword">elif</span> <span class="name">c</span><span class="operator">[</span><span class="string">'sortby'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'date'</span><span class="operator">:</span>
                <span class="name">dirnames</span>  <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">dirs</span><span class="operator">,</span>  <span class="name">key</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">k</span><span class="operator">:</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span><span class="operator">[</span><span class="string">'ctime'</span><span class="operator">]</span> <span class="operator">)</span>
                <span class="name">filenames</span> <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">files</span><span class="operator">,</span> <span class="name">key</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">k</span><span class="operator">:</span> <span class="name">files</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span><span class="operator">[</span><span class="string">'ctime'</span><span class="operator">]</span> <span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="keyword">raise</span> <span class="name">Exception</span><span class="operator">(</span><span class="string">'on folder %s: unknown sortby method'</span> <span class="operator">%</span> <span class="name">dirname</span><span class="operator">)</span>

        <span class="name">basedirname</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">basename</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span>

        <span class="name">dropboxref</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">[</span><span class="string">'dropbox_referrer'</span><span class="operator">]</span>
        <span class="name">dic</span><span class="operator">[</span><span class="string">'dropboxref'</span><span class="operator">]</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">,</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'dropboxref'</span><span class="operator">]</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">)</span> <span class="operator">%</span> <span class="name">dict</span><span class="operator">(</span><span class="name">dropboxref</span><span class="operator">=</span><span class="name">dropboxref</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'title'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">currentfolder</span><span class="operator">=</span><span class="name">basedirname</span><span class="operator">)</span><span class="operator">)</span>
        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'currentfolderth'</span><span class="operator">]</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'b'</span><span class="operator">)</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">currentfolder</span><span class="operator">=</span><span class="name">basedirname</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">parent</span> <span class="operator">=</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'parent'</span><span class="operator">]</span>
        <span class="keyword">if</span> <span class="name">parent</span> <span class="keyword">is</span> <span class="name">None</span> <span class="keyword">or</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">parent</span><span class="operator">]</span><span class="operator">[</span><span class="string">'confdict'</span><span class="operator">]</span><span class="operator">[</span><span class="string">'skipdir'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'yes'</span><span class="operator">:</span>
                <span class="name">dic</span><span class="operator">[</span><span class="string">'updirtr'</span><span class="operator">]</span><span class="operator">.</span><span class="name">parentNode</span><span class="operator">.</span><span class="name">removeChild</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'updirtr'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="keyword">del</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'updirtr'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="name">setEntryRow</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'updirtr'</span><span class="operator">]</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'td'</span><span class="operator">)</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">indexfilename</span><span class="operator">=</span><span class="name">c</span><span class="operator">[</span><span class="string">'indexfilename'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span>

        <span class="keyword">for</span> <span class="name">subdirname</span> <span class="keyword">in</span> <span class="name">dirnames</span><span class="operator">:</span>
                <span class="name">basesubdirname</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">basename</span><span class="operator">(</span><span class="name">subdirname</span><span class="operator">)</span>
                <span class="name">skipdir</span> <span class="operator">=</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">subdirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'confdict'</span><span class="operator">]</span><span class="operator">[</span><span class="string">'skipdir'</span><span class="operator">]</span>
                <span class="keyword">if</span> <span class="name">skipdir</span> <span class="operator">==</span> <span class="string">'yes'</span><span class="operator">:</span>
                        <span class="keyword">continue</span> <span class="comment"># FIXME counts of parent are skewed because of this :( - see other FIXME on lsdir</span>
                        <span class="comment">#Exception('Barf, skipdir==yes in index, should not happen. Report')
</span>                <span class="keyword">elif</span> <span class="name">skipdir</span> <span class="operator">!=</span> <span class="string">'no'</span><span class="operator">:</span> <span class="comment"># just make a link to requested file</span>
                        <span class="name">dirname_link</span> <span class="operator">=</span> <span class="name">basesubdirname</span><span class="operator">+</span><span class="string">'/'</span><span class="operator">+</span><span class="name">skipdir</span>
                <span class="keyword">else</span><span class="operator">:</span> <span class="comment"># recursive</span>
                        <span class="name">dirname_link</span> <span class="operator">=</span> <span class="name">basesubdirname</span><span class="operator">+</span><span class="string">'/'</span><span class="operator">+</span><span class="name">c</span><span class="operator">[</span><span class="string">'indexfilename'</span><span class="operator">]</span>

                <span class="keyword">if</span> <span class="name">c</span><span class="operator">[</span><span class="string">'subdirsize'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'size'</span><span class="operator">:</span>
                        <span class="name">size</span> <span class="operator">=</span> <span class="name">HumanSize</span><span class="operator">(</span><span class="name">indexingdict</span><span class="operator">[</span><span class="name">subdirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'size'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="keyword">elif</span> <span class="name">c</span><span class="operator">[</span><span class="string">'subdirsize'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'count'</span><span class="operator">:</span>
                        <span class="name">size</span> <span class="operator">=</span> <span class="string">'%s items'</span> <span class="operator">%</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">subdirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'count'</span><span class="operator">]</span>
                <span class="name">ctime</span> <span class="operator">=</span> <span class="name">dt</span><span class="operator">.</span><span class="name">fromtimestamp</span><span class="operator">(</span><span class="name">indexingdict</span><span class="operator">[</span><span class="name">subdirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'ctime'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">.</span><span class="name">strftime</span><span class="operator">(</span><span class="name">c</span><span class="operator">[</span><span class="string">'dateformat'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">d</span> <span class="operator">=</span> <span class="name">dict</span><span class="operator">(</span>
                        <span class="name">dirname_link</span><span class="operator">=</span><span class="name">dirname_link</span><span class="operator">,</span>
                        <span class="name">dirname_text</span><span class="operator">=</span><span class="name">basesubdirname</span><span class="operator">,</span>
                        <span class="name">dirsize</span><span class="operator">=</span><span class="name">size</span><span class="operator">,</span>
                        <span class="name">dirdate</span><span class="operator">=</span><span class="name">ctime</span><span class="operator">,</span>
                        <span class="operator">)</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">htmlbase</span><span class="operator">.</span><span class="name">importNode</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'direntry'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">True</span><span class="operator">)</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">appendChild</span><span class="operator">(</span><span class="name">newrow</span><span class="operator">)</span>
                <span class="name">setEntryRow</span><span class="operator">(</span><span class="name">newrow</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'td'</span><span class="operator">)</span><span class="operator">,</span> <span class="name">d</span><span class="operator">)</span>

        <span class="name">playfiles</span> <span class="operator">=</span> <span class="number">0</span>
        <span class="keyword">for</span> <span class="name">filename</span> <span class="keyword">in</span> <span class="name">filenames</span><span class="operator">:</span>
                <span class="name">basefilename</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">basename</span><span class="operator">(</span><span class="name">filename</span><span class="operator">)</span>

                <span class="name">size</span> <span class="operator">=</span> <span class="name">HumanSize</span><span class="operator">(</span><span class="name">files</span><span class="operator">[</span><span class="name">filename</span><span class="operator">]</span><span class="operator">[</span><span class="string">'size'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">ctime</span> <span class="operator">=</span> <span class="name">dt</span><span class="operator">.</span><span class="name">fromtimestamp</span><span class="operator">(</span><span class="name">files</span><span class="operator">[</span><span class="name">filename</span><span class="operator">]</span><span class="operator">[</span><span class="string">'ctime'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">.</span><span class="name">strftime</span><span class="operator">(</span><span class="name">c</span><span class="operator">[</span><span class="string">'dateformat'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">ftype</span> <span class="operator">=</span> <span class="name">fileTypes</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">splitext</span><span class="operator">(</span><span class="name">filename</span><span class="operator">)</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span><span class="operator">.</span><span class="name">lstrip</span><span class="operator">(</span><span class="string">'.'</span><span class="operator">)</span><span class="operator">,</span> <span class="name">fileTypes</span><span class="operator">[</span><span class="name">None</span><span class="operator">]</span><span class="operator">)</span>
                <span class="keyword">if</span> <span class="name">patmatch</span><span class="operator">(</span><span class="name">basefilename</span><span class="operator">,</span> <span class="name">c</span><span class="operator">[</span><span class="string">'viewinbrowser'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="name">basefilenamelnk</span> <span class="operator">=</span> <span class="name">basefilename</span>
                <span class="keyword">else</span><span class="operator">:</span>
                        <span class="name">basefilenamelnk</span> <span class="operator">=</span> <span class="name">basefilename</span><span class="operator">+</span><span class="string">'?dl'</span>

                <span class="name">d</span> <span class="operator">=</span> <span class="name">dict</span><span class="operator">(</span><span class="name">filename_link</span><span class="operator">=</span><span class="name">basefilenamelnk</span><span class="operator">,</span> <span class="name">filename_text</span><span class="operator">=</span><span class="name">basefilename</span><span class="operator">,</span> <span class="name">filename_type</span><span class="operator">=</span><span class="name">ftype</span><span class="operator">,</span> <span class="name">filesize</span><span class="operator">=</span><span class="name">size</span><span class="operator">,</span> <span class="name">filedate</span><span class="operator">=</span><span class="name">ctime</span><span class="operator">)</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">htmlbase</span><span class="operator">.</span><span class="name">importNode</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'fileentry'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">True</span><span class="operator">)</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">appendChild</span><span class="operator">(</span><span class="name">newrow</span><span class="operator">)</span>
                <span class="name">setEntryRow</span><span class="operator">(</span><span class="name">newrow</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'td'</span><span class="operator">)</span><span class="operator">,</span> <span class="name">d</span><span class="operator">)</span>

                <span class="keyword">if</span> <span class="name">patmatch</span><span class="operator">(</span><span class="name">basefilename</span><span class="operator">,</span> <span class="name">c</span><span class="operator">[</span><span class="string">'playinbrowser'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="name">playfiles</span> <span class="operator">+=</span> <span class="number">1</span>
                        <span class="name">img</span> <span class="operator">=</span> <span class="name">newrow</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'img'</span><span class="operator">)</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span>
                        <span class="name">audiolink</span><span class="operator">=</span><span class="string">"javascript:playthis(this, '%s');"</span> <span class="operator">%</span> <span class="name">basefilename</span>
                        <span class="name">img</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'onclick'</span><span class="operator">,</span> <span class="name">audiolink</span><span class="operator">)</span>

        <span class="keyword">if</span> <span class="name">playfiles</span><span class="operator">:</span>
                <span class="name">dic</span><span class="operator">[</span><span class="string">'playerdiv'</span><span class="operator">]</span><span class="operator">.</span><span class="name">childNodes</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">.</span><span class="name">replaceWholeText</span><span class="operator">(</span><span class="string">'Some media files can be played online, click on the file icon.'</span><span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'jsswfobj'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'jsjwplay'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'jwplayerrow'</span><span class="operator">]</span><span class="operator">)</span>

        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span> <span class="name">None</span><span class="operator">,</span> <span class="string">'direntry'</span><span class="operator">)</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">,</span> <span class="string">'tr'</span><span class="operator">,</span> <span class="name">None</span><span class="operator">,</span> <span class="string">'fileentry'</span><span class="operator">)</span><span class="operator">:</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">htmlbase</span><span class="operator">.</span><span class="name">importNode</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'emptytr'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">True</span><span class="operator">)</span>
                <span class="name">newrow</span> <span class="operator">=</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">appendChild</span><span class="operator">(</span><span class="name">newrow</span><span class="operator">)</span>

        <span class="name">gendate</span> <span class="operator">=</span> <span class="name">dt</span><span class="operator">.</span><span class="name">now</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">strftime</span><span class="operator">(</span><span class="name">c</span><span class="operator">[</span><span class="string">'dateformat'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'lastmodifiedth'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">gendate</span><span class="operator">=</span><span class="name">gendate</span><span class="operator">)</span><span class="operator">)</span>
        <span class="name">a</span> <span class="operator">=</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'pyndexerref'</span><span class="operator">]</span>
        <span class="name">a</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">,</span> <span class="name">a</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'href'</span><span class="operator">)</span> <span class="operator">%</span> <span class="name">dict</span><span class="operator">(</span><span class="name">pyndexer_url</span><span class="operator">=</span><span class="name">c</span><span class="operator">[</span><span class="string">'pyndexer_url'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span>
        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">a</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">pyndexer_ver</span><span class="operator">=</span><span class="string">'%d.%d.%d'</span> <span class="operator">%</span> <span class="name">version</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">tbodychildrenxml</span> <span class="operator">=</span> <span class="string">''</span>
        <span class="keyword">for</span> <span class="name">child</span> <span class="keyword">in</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'tr'</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">child</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'id'</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">'encryptedrow'</span><span class="operator">:</span> <span class="keyword">continue</span>
                <span class="name">tbodychildrenxml</span> <span class="operator">+=</span> <span class="name">child</span><span class="operator">.</span><span class="name">toxml</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">encode</span><span class="operator">(</span><span class="string">'utf-8'</span><span class="operator">,</span> <span class="string">'xmlcharrefreplace'</span><span class="operator">)</span>

        <span class="keyword">if</span> <span class="name">hascrypto</span> <span class="keyword">and</span> <span class="name">c</span><span class="operator">[</span><span class="string">'password'</span><span class="operator">]</span> <span class="operator">!=</span> <span class="string">''</span><span class="operator">:</span>
                <span class="keyword">for</span> <span class="name">child</span> <span class="keyword">in</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">getElementsByTagName</span><span class="operator">(</span><span class="string">'tr'</span><span class="operator">)</span><span class="operator">:</span>
                        <span class="keyword">if</span> <span class="name">child</span><span class="operator">.</span><span class="name">getAttribute</span><span class="operator">(</span><span class="string">'id'</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">'encryptedrow'</span><span class="operator">:</span> <span class="keyword">continue</span>
                        <span class="name">delElem</span><span class="operator">(</span><span class="name">child</span><span class="operator">)</span>
                <span class="keyword">for</span> <span class="name">child</span> <span class="keyword">in</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">childNodes</span><span class="operator">:</span> <span class="comment"># remove empty text</span>
                        <span class="keyword">if</span> <span class="name">child</span><span class="operator">.</span><span class="name">nodeType</span> <span class="operator">==</span> <span class="name">child</span><span class="operator">.</span><span class="name">TEXT_NODE</span><span class="operator">:</span>
                                <span class="name">delElem</span><span class="operator">(</span><span class="name">child</span><span class="operator">)</span>
                <span class="name">ciphertext</span> <span class="operator">=</span> <span class="name">encrypt</span><span class="operator">(</span><span class="name">tbodychildrenxml</span><span class="operator">,</span> <span class="name">c</span><span class="operator">[</span><span class="string">'password'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">cipherwrap</span> <span class="operator">=</span> <span class="string">'\n'</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">wrap</span><span class="operator">(</span><span class="name">ciphertext</span><span class="operator">,</span> <span class="number">64</span><span class="operator">)</span><span class="operator">)</span>
                <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'title'</span><span class="operator">,</span> <span class="name">cipherwrap</span><span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="name">dic</span><span class="operator">[</span><span class="string">'maintablebody'</span><span class="operator">]</span><span class="operator">.</span><span class="name">removeAttribute</span><span class="operator">(</span><span class="string">'title'</span><span class="operator">)</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'jsenc'</span><span class="operator">]</span><span class="operator">)</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'encryptedrow'</span><span class="operator">]</span><span class="operator">)</span>

        <span class="name">readmefile</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">,</span><span class="name">c</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="comment">###if c['readme'] != '' 
</span>        <span class="keyword">if</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isfile</span><span class="operator">(</span><span class="name">readmefile</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">if</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">splitext</span><span class="operator">(</span><span class="name">readmefile</span><span class="operator">)</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span><span class="operator">.</span><span class="name">lower</span><span class="operator">(</span><span class="operator">)</span> <span class="operator">==</span> <span class="string">'.html'</span><span class="operator">:</span>
                        <span class="name">readmehtml</span> <span class="operator">=</span> <span class="name">minidom</span><span class="operator">.</span><span class="name">parse</span><span class="operator">(</span><span class="name">readmefile</span><span class="operator">)</span>
                        <span class="name">readmebody</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">readmehtml</span><span class="operator">,</span> <span class="string">'body'</span><span class="operator">)</span>
                        <span class="name">readmebody</span><span class="operator">.</span><span class="name">tagName</span> <span class="operator">=</span> <span class="string">'div'</span>
                        <span class="name">readmebody</span><span class="operator">.</span><span class="name">setAttribute</span><span class="operator">(</span><span class="string">'id'</span><span class="operator">,</span> <span class="string">'readme'</span><span class="operator">)</span>
                        <span class="name">dic</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span><span class="operator">.</span><span class="name">replaceChild</span><span class="operator">(</span><span class="name">readmebody</span><span class="operator">,</span> <span class="name">dic</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span><span class="operator">.</span><span class="name">childNodes</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span><span class="operator">)</span>
                <span class="keyword">else</span><span class="operator">:</span>
                        <span class="name">readmetext</span> <span class="operator">=</span> <span class="name">file</span><span class="operator">(</span><span class="name">readmefile</span><span class="operator">,</span><span class="string">'rb'</span><span class="operator">)</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span>
                        <span class="name">dic</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span><span class="operator">.</span><span class="name">childNodes</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">.</span><span class="name">replaceWholeText</span><span class="operator">(</span><span class="name">readmetext</span><span class="operator">)</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="name">delElem</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'readme'</span><span class="operator">]</span><span class="operator">)</span>

        <span class="comment"># see if we really need to write the new index file.
</span>        <span class="comment"># using md5 to 'compress' info wrote. if the same, no need to rewrite
</span>        <span class="comment"># will add password on end of the md5 - (so will reindex on passwd change)
</span>        <span class="name">md5digest</span> <span class="operator">=</span> <span class="name">md5</span><span class="operator">(</span><span class="name">tbodychildrenxml</span> <span class="operator">+</span> <span class="name">c</span><span class="operator">[</span><span class="string">'password'</span><span class="operator">]</span><span class="operator">)</span><span class="operator">.</span><span class="name">hexdigest</span><span class="operator">(</span><span class="operator">)</span>
        <span class="name">setTextNodes</span><span class="operator">(</span><span class="name">dic</span><span class="operator">[</span><span class="string">'md5span'</span><span class="operator">]</span><span class="operator">,</span> <span class="name">dict</span><span class="operator">(</span><span class="name">md5span</span><span class="operator">=</span><span class="name">md5digest</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">indexfilename</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">,</span><span class="name">c</span><span class="operator">[</span><span class="string">'indexfilename'</span><span class="operator">]</span><span class="operator">)</span>
        <span class="keyword">if</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isfile</span><span class="operator">(</span><span class="name">indexfilename</span><span class="operator">)</span><span class="operator">:</span> <span class="comment"># already there</span>
                <span class="keyword">try</span><span class="operator">:</span>
                        <span class="name">oldindex</span> <span class="operator">=</span> <span class="name">minidom</span><span class="operator">.</span><span class="name">parse</span><span class="operator">(</span><span class="name">indexfilename</span><span class="operator">)</span>
                        <span class="name">oldmd5span</span> <span class="operator">=</span> <span class="name">getElem</span><span class="operator">(</span><span class="name">oldindex</span><span class="operator">,</span> <span class="string">'span'</span><span class="operator">,</span> <span class="string">'md5span'</span><span class="operator">)</span>
                        <span class="keyword">if</span> <span class="name">oldmd5span</span><span class="operator">:</span>
                                <span class="name">oldmd5digest</span> <span class="operator">=</span> <span class="name">oldmd5span</span><span class="operator">.</span><span class="name">firstChild</span><span class="operator">.</span><span class="name">wholeText</span>
                                <span class="keyword">if</span> <span class="name">md5digest</span> <span class="operator">==</span> <span class="name">oldmd5digest</span><span class="operator">:</span> <span class="comment"># wee, a disk write spared ;)</span>
                                        <span class="keyword">return</span> <span class="name">False</span>
                <span class="keyword">except</span> <span class="name">Exception</span><span class="operator">:</span> <span class="comment"># uh, some problem parsing, or not generated by me, anyway, rewrite the index</span>
                        <span class="keyword">pass</span>
        <span class="name">file</span><span class="operator">(</span><span class="name">indexfilename</span><span class="operator">,</span><span class="string">'wb'</span><span class="operator">)</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">htmlbase</span><span class="operator">.</span><span class="name">toxml</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">encode</span><span class="operator">(</span><span class="string">'utf-8'</span><span class="operator">,</span> <span class="string">'xmlcharrefreplace'</span><span class="operator">)</span><span class="operator">)</span>
        <span class="keyword">return</span> <span class="name">True</span>


<span class="keyword">def</span> <span class="name">walkindex</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
        <span class="string">'''recursive indexing, stopping on ignored children'''</span>
        <span class="name">indexed</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span>
        <span class="keyword">if</span> <span class="name">index</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">dirname</span><span class="operator">)</span><span class="operator">:</span>
                <span class="name">indexed</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span>
                <span class="keyword">for</span> <span class="name">subdir</span> <span class="keyword">in</span> <span class="name">indexingdict</span><span class="operator">[</span><span class="name">dirname</span><span class="operator">]</span><span class="operator">[</span><span class="string">'dirs'</span><span class="operator">]</span><span class="operator">:</span>
                        <span class="name">indexed</span> <span class="operator">+=</span> <span class="name">walkindex</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">subdir</span><span class="operator">)</span>
        <span class="keyword">return</span> <span class="name">indexed</span>


<span class="comment"># Execution
</span><span class="keyword">if</span> <span class="name">__name__</span> <span class="operator">==</span> <span class="string">"__main__"</span><span class="operator">:</span>
        <span class="name">setlocale</span><span class="operator">(</span><span class="name">LC_ALL</span><span class="operator">,</span><span class="string">""</span><span class="operator">)</span>
        <span class="name">config</span> <span class="operator">=</span> <span class="name">ConfigParser</span><span class="operator">.</span><span class="name">SafeConfigParser</span><span class="operator">(</span><span class="operator">)</span>
        <span class="comment"># will use this as startup for my dependencies if not found in same dir as me
</span>        <span class="name">argv</span> <span class="operator">=</span> <span class="name">GetArgv</span><span class="operator">(</span><span class="operator">)</span>

        <span class="name">mypath</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">abspath</span><span class="operator">(</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">dirname</span><span class="operator">(</span><span class="name">argv</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span>
        <span class="name">ini</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">mypath</span><span class="operator">,</span><span class="string">'pyndexer.ini'</span><span class="operator">)</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isfile</span><span class="operator">(</span><span class="name">ini</span><span class="operator">)</span><span class="operator">:</span>
                <span class="comment"># FIXME should be less stubborn. I could have the defaults inside here.
</span>                <span class="comment"># Anyway, we need the default template file, so...
</span>                <span class="keyword">print</span> <span class="string">'Downloading default INI file...'</span>
                <span class="name">file</span><span class="operator">(</span><span class="name">ini</span><span class="operator">,</span><span class="string">'wb'</span><span class="operator">)</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">urlopen</span><span class="operator">(</span><span class="name">base_source</span><span class="operator">+</span><span class="string">'pyndexer.empty.ini'</span><span class="operator">)</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span>
        <span class="keyword">print</span> <span class="string">'Reading config file %s'</span> <span class="operator">%</span> <span class="name">ini</span>
        <span class="name">config</span><span class="operator">.</span><span class="name">readfp</span><span class="operator">(</span><span class="name">codecs</span><span class="operator">.</span><span class="name">open</span><span class="operator">(</span><span class="name">ini</span><span class="operator">,</span><span class="string">'r'</span><span class="operator">,</span><span class="string">'utf-8'</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">template</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">mypath</span><span class="operator">,</span><span class="string">'pyndexer.template.html'</span><span class="operator">)</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isfile</span><span class="operator">(</span><span class="name">template</span><span class="operator">)</span><span class="operator">:</span>
                <span class="keyword">print</span> <span class="string">'Downloading default HTML template...'</span>
                <span class="name">file</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span><span class="string">'wb'</span><span class="operator">)</span><span class="operator">.</span><span class="name">write</span><span class="operator">(</span><span class="name">urlopen</span><span class="operator">(</span><span class="name">base_source</span><span class="operator">+</span><span class="string">'pyndexer.template.html'</span><span class="operator">)</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span>

        <span class="name">dbfolder</span> <span class="operator">=</span> <span class="name">dbconfig</span><span class="operator">.</span><span class="name">DBConfig</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">dbfolder</span>
        <span class="name">publicfolder</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">dbfolder</span><span class="operator">,</span><span class="string">'Public'</span><span class="operator">+</span><span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">sep</span><span class="operator">)</span>
        <span class="name">config</span><span class="operator">.</span><span class="name">set</span><span class="operator">(</span><span class="string">'DEFAULT'</span><span class="operator">,</span><span class="string">'publicfolder'</span><span class="operator">,</span> <span class="name">publicfolder</span><span class="operator">)</span>

        <span class="keyword">if</span> <span class="name">len</span><span class="operator">(</span><span class="name">argv</span><span class="operator">)</span> <span class="operator">&gt;</span> <span class="number">1</span><span class="operator">:</span>
                <span class="name">dirnames</span> <span class="operator">=</span> <span class="operator">[</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">abspath</span><span class="operator">(</span><span class="name">d</span><span class="operator">)</span><span class="operator">.</span><span class="name">decode</span><span class="operator">(</span><span class="string">'UTF-8'</span><span class="operator">)</span> <span class="keyword">for</span> <span class="name">d</span> <span class="keyword">in</span> <span class="name">argv</span><span class="operator">[</span><span class="number">1</span><span class="operator">:</span><span class="operator">]</span> <span class="operator">]</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="comment"># XXX: should open a GUI at some point in the future
</span>                <span class="keyword">try</span><span class="operator">:</span>
                        <span class="keyword">if</span> <span class="name">config</span><span class="operator">.</span><span class="name">sections</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span>
                                <span class="name">sections</span> <span class="operator">=</span> <span class="name">sorted</span><span class="operator">(</span><span class="name">config</span><span class="operator">.</span><span class="name">sections</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span>
                                <span class="keyword">print</span> <span class="string">'\nWill process the following configured folders:'</span>
                                <span class="name">dirnames</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span>
                                <span class="keyword">for</span> <span class="name">d</span> <span class="keyword">in</span> <span class="name">sections</span><span class="operator">:</span>
                                        <span class="keyword">print</span> <span class="name">d</span>
                                        <span class="keyword">if</span> <span class="name">sys</span><span class="operator">.</span><span class="name">platform</span> <span class="operator">==</span> <span class="string">'win32'</span><span class="operator">:</span>
                                                <span class="name">fulld</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">publicfolder</span><span class="operator">,</span> <span class="name">d</span><span class="operator">.</span><span class="name">replace</span><span class="operator">(</span><span class="string">'/'</span><span class="operator">,</span><span class="string">'\\'</span><span class="operator">)</span><span class="operator">)</span><span class="operator">.</span><span class="name">decode</span><span class="operator">(</span><span class="string">'UTF-8'</span><span class="operator">)</span>
                                        <span class="keyword">else</span><span class="operator">:</span>
                                                <span class="name">fulld</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">join</span><span class="operator">(</span><span class="name">publicfolder</span><span class="operator">,</span> <span class="name">d</span><span class="operator">)</span><span class="operator">.</span><span class="name">decode</span><span class="operator">(</span><span class="string">'UTF-8'</span><span class="operator">)</span>
                                        <span class="name">dirnames</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">fulld</span><span class="operator">)</span>
                                <span class="name">raw_input</span><span class="operator">(</span><span class="string">'\nPress ^C to cancel, or ENTER to confirm:'</span><span class="operator">)</span>
                        <span class="keyword">else</span><span class="operator">:</span>
                                <span class="name">raw_input</span><span class="operator">(</span><span class="string">'No configured folders found, ENTER to exit:'</span><span class="operator">)</span>
                                <span class="name">sys</span><span class="operator">.</span><span class="name">exit</span><span class="operator">(</span><span class="number">1</span><span class="operator">)</span>
                <span class="keyword">except</span> <span class="name">KeyboardInterrupt</span><span class="operator">:</span>
                        <span class="name">sys</span><span class="operator">.</span><span class="name">exit</span><span class="operator">(</span><span class="number">1</span><span class="operator">)</span>
        <span class="keyword">for</span> <span class="name">d</span> <span class="keyword">in</span> <span class="name">dirnames</span><span class="operator">:</span>
                <span class="keyword">assert</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">isdir</span><span class="operator">(</span><span class="name">d</span><span class="operator">)</span><span class="operator">,</span> <span class="name">Exception</span><span class="operator">(</span><span class="string">u'%s is not a folder'</span> <span class="operator">%</span> <span class="name">d</span><span class="operator">)</span>

        <span class="name">indexingdict</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span>
        <span class="name">indexed</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span>
        <span class="keyword">print</span> <span class="string">'\nStarting index\n'</span>
        <span class="keyword">for</span> <span class="name">dirname</span> <span class="keyword">in</span> <span class="name">dirnames</span><span class="operator">:</span>
                <span class="name">fulldirname</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">abspath</span><span class="operator">(</span><span class="name">dirname</span><span class="operator">)</span>
                <span class="keyword">if</span> <span class="name">fulldirname</span> <span class="keyword">in</span> <span class="name">indexed</span><span class="operator">:</span> <span class="keyword">continue</span>
                <span class="comment"># W:walking, I:indexing, then OK or Ign (up-to-date or explicitly ignored)
</span>                <span class="keyword">print</span> <span class="string">'%s: ['</span> <span class="operator">%</span> <span class="name">dirname</span><span class="operator">.</span><span class="name">replace</span><span class="operator">(</span><span class="name">config</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="string">'DEFAULT'</span><span class="operator">,</span><span class="string">'publicfolder'</span><span class="operator">)</span><span class="operator">,</span><span class="string">''</span><span class="operator">)</span><span class="operator">,</span>
                <span class="keyword">try</span><span class="operator">:</span>
                        <span class="keyword">print</span> <span class="string">'W'</span><span class="operator">,</span>
                        <span class="name">walkdir</span><span class="operator">(</span><span class="name">config</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">None</span><span class="operator">,</span> <span class="name">fulldirname</span><span class="operator">)</span>
                        <span class="keyword">print</span> <span class="string">'I'</span><span class="operator">,</span>
                        <span class="name">result</span> <span class="operator">=</span> <span class="name">walkindex</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">indexingdict</span><span class="operator">,</span> <span class="name">fulldirname</span><span class="operator">)</span>
                        <span class="keyword">if</span> <span class="name">result</span><span class="operator">:</span>
                                <span class="name">indexed</span> <span class="operator">+=</span> <span class="name">result</span>
                                <span class="keyword">print</span> <span class="string">'OK ] (%d folders)'</span> <span class="operator">%</span> <span class="name">len</span><span class="operator">(</span><span class="name">result</span><span class="operator">)</span>
                        <span class="keyword">else</span><span class="operator">:</span>
                                <span class="keyword">print</span> <span class="string">'Ign ]'</span>
                <span class="keyword">except</span> <span class="name">Exception</span><span class="operator">,</span> <span class="name">e</span><span class="operator">:</span>
                        <span class="keyword">print</span> <span class="string">'Exception raised, aborting:'</span>
                        <span class="keyword">print</span> <span class="name">e</span>
                        <span class="keyword">raise</span>
        <span class="keyword">if</span> <span class="name">indexed</span><span class="operator">:</span>
                <span class="keyword">print</span> <span class="string">'\nFinished. Folders indexed:'</span>
                <span class="keyword">for</span> <span class="name">d</span> <span class="keyword">in</span> <span class="name">indexed</span><span class="operator">:</span> <span class="keyword">print</span> <span class="name">d</span>
        <span class="keyword">else</span><span class="operator">:</span>
                <span class="keyword">print</span> <span class="string">'\nFinished. No folders where indexed (up-to-date or ignored).'</span>
        <span class="name">raw_input</span><span class="operator">(</span><span class="string">'Press ENTER to exit...'</span><span class="operator">)</span>
        <span class="comment"># That's all folks!</span><span class="text"></span>
</pre></body>
</html>
